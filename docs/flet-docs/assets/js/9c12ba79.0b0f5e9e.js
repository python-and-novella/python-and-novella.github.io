"use strict";(self.webpackChunkflet_dev=self.webpackChunkflet_dev||[]).push([[75813],{13148:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>r,default:()=>h,frontMatter:()=>o,metadata:()=>l,toc:()=>d});var t=s(74848),i=s(28453);const o={slug:"flet-fastapi-and-async-api-improvements",title:"Flet FastAPI and async API improvements",author:"Feodor Fitsner",author_title:"Flet founder and developer",author_url:"https://github.com/FeodorFitsner",author_image_url:"https://avatars0.githubusercontent.com/u/5041459?s=400&v=4",tags:["releases"]},r=void 0,l={permalink:"/docs/flet-docs/blog/flet-fastapi-and-async-api-improvements",editUrl:"https://github.com/flet-dev/website/edit/main/blog/2024-03-06-flet-fastapi-and-async-api-improvements.md",source:"@site/blog/2024-03-06-flet-fastapi-and-async-api-improvements.md",title:"Flet FastAPI and async API improvements",description:"Flet makes writing dynamic, real-time web apps a real fun!",date:"2024-03-06T00:00:00.000Z",tags:[{inline:!0,label:"releases",permalink:"/docs/flet-docs/blog/tags/releases"}],readingTime:5.735,hasTruncateMarker:!1,authors:[{name:"Feodor Fitsner",title:"Flet founder and developer",url:"https://github.com/FeodorFitsner",imageURL:"https://avatars0.githubusercontent.com/u/5041459?s=400&v=4"}],frontMatter:{slug:"flet-fastapi-and-async-api-improvements",title:"Flet FastAPI and async API improvements",author:"Feodor Fitsner",author_title:"Flet founder and developer",author_url:"https://github.com/FeodorFitsner",author_image_url:"https://avatars0.githubusercontent.com/u/5041459?s=400&v=4",tags:["releases"]},unlisted:!1,prevItem:{title:"Controls and theming enhancements",permalink:"/docs/flet-docs/blog/controls-and-theming-enhancements"},nextItem:{title:"Flet adaptive UI and custom controls release",permalink:"/docs/flet-docs/blog/flet-adaptive-and-custom-controls"}},a={authorsImageUrls:[void 0]},d=[{value:"FastAPI with Uvicorn replaces built-in web server",id:"fastapi-with-uvicorn-replaces-built-in-web-server",level:2},{value:"Async-first framework",id:"async-first-framework",level:2},{value:"Custom controls API normalized",id:"custom-controls-api-normalized",level:2},{value:"New Cupertino controls",id:"new-cupertino-controls",level:2},{value:"Accessibility improvements",id:"accessibility-improvements",level:2},{value:"App lifecycle change event",id:"app-lifecycle-change-event",level:2}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.p,{children:"Flet makes writing dynamic, real-time web apps a real fun!"}),"\n",(0,t.jsx)(n.p,{children:"Flet 0.21.0 further improves web apps development experience as well as using asyncio APIs in your Flet apps."}),"\n",(0,t.jsx)(n.p,{children:"Here's what's new in Flet 0.21.0:"}),"\n",(0,t.jsx)(n.h2,{id:"fastapi-with-uvicorn-replaces-built-in-web-server",children:"FastAPI with Uvicorn replaces built-in web server"}),"\n",(0,t.jsxs)(n.p,{children:['From very beginning of Flet life to serve web apps there was a built-in web server written in Go\nand called "Fletd". It\'s being started on the background when you run your app with ',(0,t.jsx)(n.code,{children:"flet run --web"}),".\nFletd was part of Flet Python wheel contributing a few megabytes to its size.\nAdditionally, Python app was using WebSockets to talk to Fletd web server which was adding sometimes noticeable overhead."]}),"\n",(0,t.jsxs)(n.p,{children:["Then, in ",(0,t.jsx)(n.a,{href:"/blog/flet-for-fastapi",children:"Flet 0.10.0"}),' we have added FastAPI support to build "serious" web apps using AsyncIO API.']}),"\n",(0,t.jsx)(n.p,{children:"Now, in Flet 0.21.0 built-in web server has been completely removed and replaced with FastAPI and Uvicorn. Fletd is not\na part of Flet distribution anymore."}),"\n",(0,t.jsxs)(n.p,{children:["Using FastAPI means there is no more communication overhead as web server is a part of Flet app.\nAlso, you don't need to do any additional steps to host your app in production with FastAPI -\nyou just use the same ",(0,t.jsx)(n.code,{children:"ft.app(main)"})," command to run your app."]}),"\n",(0,t.jsxs)(n.admonition,{title:"Breaking change",type:"warning",children:[(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"flet_fastapi"})," package has been deprecated and its contents moved to ",(0,t.jsx)(n.code,{children:"flet"})," package as ",(0,t.jsx)(n.code,{children:"flet.fastapi"}),"\nmodule. If you were using FastAPI in your Flet app replace:"]}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"import flet_fastapi\n"})}),(0,t.jsx)(n.p,{children:"with"}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"import flet.fastapi as flet_fastapi\n"})})]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Use any ASGI web server for hosting"})}),"\n",(0,t.jsxs)(n.p,{children:["You can host your Flet web app with any ASGI-compatible server such as ",(0,t.jsx)(n.a,{href:"https://www.uvicorn.org/",children:"Uvicorn"})," (used by default), ",(0,t.jsx)(n.a,{href:"https://pgjones.gitlab.io/hypercorn/",children:"Hypercorn"})," or ",(0,t.jsx)(n.a,{href:"https://github.com/django/daphne",children:"Daphne"}),"."]}),"\n",(0,t.jsx)(n.p,{children:"Just tell Flet to export ASGI app:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",metastring:'title="main.py"',children:'import flet as ft\n\ndef main(page: ft.Page):\n    page.add(ft.Text("Hello ASGI!"))\n\napp = ft.app(main, export_asgi_app=True)\n'})}),"\n",(0,t.jsx)(n.p,{children:"and then run with Hypercorn as:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"hypercorn main:app --bind 0.0.0.0:8000\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Web app environment variables"})}),"\n",(0,t.jsx)(n.p,{children:"Every aspect of web app hosting can be controlled with environment variables:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"FLET_FORCE_WEB_SERVER"})," - ",(0,t.jsx)(n.code,{children:"true"})," to force running app as a web app. Automatically set on headless Linux hosts."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"FLET_SERVER_PORT"})," - TCP port to run app on. ",(0,t.jsx)(n.code,{children:"8000"})," if the program is running on a Linux server or ",(0,t.jsx)(n.code,{children:"FLET_FORCE_WEB_SERVER"})," is set; otherwise random port."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"FLET_SERVER_IP"})," - IP address to listen web app on, e.g. ",(0,t.jsx)(n.code,{children:"127.0.0.1"}),". Default is ",(0,t.jsx)(n.code,{children:"0.0.0.0"})," - bound to all server IPs."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"FLET_ASSETS_DIR"}),' - absolute path to app "assets" directory.']}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"FLET_UPLOAD_DIR"}),' - absolute path to app "upload" directory.']}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"FLET_MAX_UPLOAD_SIZE"})," - max allowed size of uploaded file, in bytes. Unlimited if not specified."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"FLET_SECRET_KEY"})," - a secret key to sign temporary upload URLs."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"FLET_WEB_APP_PATH"})," - a URL path after domain name to host web app under, e.g. ",(0,t.jsx)(n.code,{children:"/apps/myapp"}),". Default is ",(0,t.jsx)(n.code,{children:"/"})," - host app in the root."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"FLET_SESSION_TIMEOUT"})," - session lifetime, in seconds. Default is ",(0,t.jsx)(n.code,{children:"3600"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"FLET_OAUTH_STATE_TIMEOUT"})," - max allowed time to complete OAuth web flow, in seconds. Default is ",(0,t.jsx)(n.code,{children:"600"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"FLET_WEB_RENDERER"})," - Flutter rendering mode: ",(0,t.jsx)(n.code,{children:"canvaskit"})," (default), ",(0,t.jsx)(n.code,{children:"html"})," or ",(0,t.jsx)(n.code,{children:"auto"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"FLET_WEB_USE_COLOR_EMOJI"})," - ",(0,t.jsx)(n.code,{children:"true"}),", or ",(0,t.jsx)(n.code,{children:"True"})," or ",(0,t.jsx)(n.code,{children:"1"})," to load web font with colorful emojis."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"FLET_WEB_ROUTE_URL_STRATEGY"})," - ",(0,t.jsx)(n.code,{children:"path"})," (default) or ",(0,t.jsx)(n.code,{children:"hash"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"FLET_WEBSOCKET_HANDLER_ENDPOINT"})," - custom path for WebSocket handler. Default is ",(0,t.jsx)(n.code,{children:"/ws"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"FLET_UPLOAD_HANDLER_ENDPOINT"})," - custom path for upload handler. Default is ",(0,t.jsx)(n.code,{children:"/upload"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"FLET_OAUTH_CALLBACK_HANDLER_ENDPOINT"})," - custom path for OAuth handler. Default is ",(0,t.jsx)(n.code,{children:"/oauth_callback"}),"."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"async-first-framework",children:"Async-first framework"}),"\n",(0,t.jsx)(n.p,{children:"Flet is now async-first framework which means you don't have to decide whether your app is entirely sync or async, but you can mix both sync and async methods in the same app."}),"\n",(0,t.jsx)(n.p,{children:"For example, in Flet 0.21.0 you can write an app like this:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'import flet as ft\nimport time\nimport asyncio\n\ndef main(page: ft.Page):\n\n    def handler(e):\n      time.sleep(3)\n      page.add(ft.Text("Handler clicked"))\n\n    async def handler_async(e):\n      await asyncio.sleep(3)\n      page.add(ft.Text("Async handler clicked"))\n\n    page.add(\n        ft.ElevatedButton("Call handler", on_click=handler),\n        ft.ElevatedButton("Call async handler", on_click=handler_async)\n    )\n\nft.app(main)\n'})}),"\n",(0,t.jsxs)(n.p,{children:['In the example above a click on one button is handled by a "blocking" handler while a click\non second button calls asynchronous handler. The first handler is run in a ',(0,t.jsx)(n.code,{children:"threading.Thread"})," while second handler is run in ",(0,t.jsx)(n.code,{children:"asyncio.Task"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["Also, notice in ",(0,t.jsx)(n.code,{children:"async def"})," handler you are not required to use ",(0,t.jsx)(n.code,{children:"await page.add_async()"})," anymore, but a regular ",(0,t.jsx)(n.code,{children:"page.add()"})," works just fine."]}),"\n",(0,t.jsxs)(n.admonition,{title:"API changes",type:"info",children:[(0,t.jsxs)(n.p,{children:["Most of ",(0,t.jsx)(n.code,{children:"Page.<method>_async()"})," and ",(0,t.jsx)(n.code,{children:"Control.<method>_async()"})," methods have been deprecated and their ",(0,t.jsx)(n.code,{children:"Page.<method>()"})," and ",(0,t.jsx)(n.code,{children:"Control.<method>()"})," counterparts should be used instead."]}),(0,t.jsxs)(n.p,{children:["The only exception here is methods returning results, like those ones in ",(0,t.jsx)(n.code,{children:"Audio"})," control: you still have to use async methods in async event handlers."]})]}),"\n",(0,t.jsx)(n.h2,{id:"custom-controls-api-normalized",children:"Custom controls API normalized"}),"\n",(0,t.jsx)(n.p,{children:"In this Flet release we also re-visited API for writing custom controls in Python."}),"\n",(0,t.jsxs)(n.p,{children:["As a result ",(0,t.jsx)(n.code,{children:"UserControl"})," class has been deprecated. You just inherit from a specific control with layout that works for your needs."]}),"\n",(0,t.jsxs)(n.p,{children:["For example, ",(0,t.jsx)(n.code,{children:"Countdown"})," custom control is just a ",(0,t.jsx)(n.code,{children:"Text"})," and could be implemented as following:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'import asyncio\n\nimport flet as ft\n\nclass Countdown(ft.Text):\n    def __init__(self, seconds):\n        super().__init__()\n        self.seconds = seconds\n\n    def did_mount(self):\n        self.running = True\n        self.page.run_task(self.update_timer)\n\n    def will_unmount(self):\n        self.running = False\n\n    async def update_timer(self):\n        while self.seconds and self.running:\n            mins, secs = divmod(self.seconds, 60)\n            self.value = "{:02d}:{:02d}".format(mins, secs)\n            self.update()\n            await asyncio.sleep(1)\n            self.seconds -= 1\n\ndef main(page: ft.Page):\n    page.add(Countdown(120), Countdown(60))\n\nft.app(main)\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Notice the usage of ",(0,t.jsx)(n.code,{children:"self.page.run_task(self.update_timer)"})," to start a new task.\nThere is also ",(0,t.jsx)(n.code,{children:"self.page.run_thread()"})," method that must be used by control developer to start a new background job in a thread."]}),"\n",(0,t.jsxs)(n.p,{children:["If you want to spawn your own tasks or threads Flet provides the current event loop and thread executor via ",(0,t.jsx)(n.code,{children:"Page.loop"})," and ",(0,t.jsx)(n.code,{children:"Page.executor"})," properties respectively."]}),"\n",(0,t.jsxs)(n.admonition,{title:"API changes",type:"info",children:[(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"Control._before_build_command()"})," replaced with ",(0,t.jsx)(n.code,{children:"Control.before_update()"})]}),(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"Control.build()"})," should not return any control now, but must update inherited control properties, for example:"]}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'def build():\n    self.controls.append(ft.Text("Something"))\n'})}),(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"Control.did_mount_async()"})," and ",(0,t.jsx)(n.code,{children:"Control.will_unmount_async()"})," are deprecated. Use ",(0,t.jsx)(n.code,{children:"Control.did_mount()"})," and ",(0,t.jsx)(n.code,{children:"Control.will_unmount()"})," instead."]})]}),"\n",(0,t.jsx)(n.h2,{id:"new-cupertino-controls",children:"New Cupertino controls"}),"\n",(0,t.jsx)(n.p,{children:"This Flet release adds more Cupertino controls to make your apps shine on iOS:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"CupertinoActivityIndicator"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"CupertinoActionSheet"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"CupertinoSlidingSegmentedButton"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"CupertinoSegmentedButton"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"CupertinoTimerPicker"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"CupertinoPicker"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"CupertinoDatePicker"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"CupertinoContextMenu"})}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"accessibility-improvements",children:"Accessibility improvements"}),"\n",(0,t.jsxs)(n.p,{children:["Now Flet has complete implementation of ",(0,t.jsx)(n.code,{children:"Semantics"})," control and new ",(0,t.jsx)(n.code,{children:"SemanticsService"})," control."]}),"\n",(0,t.jsx)(n.h2,{id:"app-lifecycle-change-event",children:"App lifecycle change event"}),"\n",(0,t.jsxs)(n.p,{children:["There is a new ",(0,t.jsx)(n.code,{children:"Page.on_app_lifecycle_state_change"})," event that allows listening for changes in the application lifecycle."]}),"\n",(0,t.jsx)(n.p,{children:"For example, you can now update UI with the latest information when the app becomes active (brought to the front). This event works on iOS, Android, all desktop platforms and web!"}),"\n",(0,t.jsx)(n.p,{children:"The following app lifecycle transitions are recognized:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"SHOW"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"RESUME"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"HIDE"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"INACTIVE"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"PAUSE"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"DETACH"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"RESTART"})}),"\n"]}),"\n",(0,t.jsx)(n.admonition,{type:"note",children:(0,t.jsxs)(n.p,{children:["Read more about each ",(0,t.jsx)(n.a,{href:"/docs/controls/page#on_app_lifecycle_state_change",children:"lifecycle state"}),"."]})}),"\n",(0,t.jsx)(n.p,{children:"Here's a small example of how this event can be used:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'import flet as ft\n\ndef main(page: ft.Page):\n\n    def app_lifecycle_change(e: ft.AppLifecycleStateChangeEvent):\n        if e.state == ft.AppLifecycleState.RESUME:\n          print("Update UI with fresh data!")\n\n    page.on_app_lifecycle_state_change = app_lifecycle_change\n    page.add(ft.Text("Hello World"))\n\nft.app(target=main)\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Flet 0.21.0 release has some breaking changes. Upgrade to it, test your apps and let us know how it worked for you.\nJoin ",(0,t.jsx)(n.a,{href:"https://discord.gg/dzWXP8SHG8",children:"Flet Discord server"})," or create a new thread\non ",(0,t.jsx)(n.a,{href:"https://github.com/flet-dev/flet/discussions",children:"Flet GitHub discussions"}),"."]}),"\n",(0,t.jsx)(n.p,{children:"Enjoy!"})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>r,x:()=>l});var t=s(96540);const i={},o=t.createContext(i);function r(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);